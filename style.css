const STORAGE_KEY = 'allnighter-user';
const participants = [];
let joined = false;
let asleep = false;
let joinTime = null;
let intervalId = null;
let lastConfirmTime = null;

function saveName() {
  const name = document.getElementById('username').value.trim();
  if (name) {
    localStorage.setItem(STORAGE_KEY, name);
    setupUI();
  }
}

function setupUI() {
  const name = localStorage.getItem(STORAGE_KEY);
  if (name) {
    document.getElementById('nameInput').style.display = 'none';
    document.getElementById('mainUI').style.display = 'block';
    updateStatus();
    updateRanking();
  }
}

function getNow() {
  return new Date();
}

function isWithinParticipationWindow() {
  const now = getNow();
  const h = now.getHours();
  const m = now.getMinutes();

  const totalMinutes = h * 60 + m;
  return totalMinutes >= 1320 && totalMinutes < 1440; // 22:00ã€œ0:00
}

function isAfterStartTime() {
  const now = getNow();
  return now.getHours() >= 22 || (now.getHours() === 0 && now.getMinutes() === 0);
}

function isBeforeEndTime() {
  const now = getNow();
  const totalMinutes = now.getHours() * 60 + now.getMinutes();
  return totalMinutes < 390; // before 6:30
}

function joinChallenge() {
  if (!isAfterStartTime()) {
    alert("22:00ã«ãªã£ã¦ã‹ã‚‰å‚åŠ ã§ãã¾ã™ã€‚");
    return;
  }
  if (!isWithinParticipationWindow()) {
    alert("å‚åŠ å—ä»˜ã¯0:00ã§çµ‚äº†ã—ã¾ã—ãŸã€‚");
    return;
  }
  if (joined) return;

  joinTime = new Date('1970-01-01T22:00:00'); // é–‹å§‹ã¯å¸¸ã«22:00ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆ
  joined = true;
  lastConfirmTime = Date.now();

  startPopupTimer();
  updateStatus();
  updateRanking();
}

function startPopupTimer() {
  intervalId = setInterval(() => {
    const now = Date.now();
    if (now - lastConfirmTime >= 10 * 60 * 1000) { // 10åˆ†
      const confirmed = confirm("èµ·ãã¦ã„ã¾ã™ã‹ï¼Ÿï¼ˆ3åˆ†ä»¥å†…ã«æŠ¼ã—ã¦ãã ã•ã„ï¼‰");
      if (confirmed) {
        lastConfirmTime = Date.now();
      } else {
        asleep = true;
        clearInterval(intervalId);
        updateStatus();
        updateRanking();
      }
    }
  }, 60 * 1000); // æ¯åˆ†ãƒã‚§ãƒƒã‚¯
}

function calculateElapsedMinutes() {
  const now = new Date();
  return Math.floor((now - joinTime) / 60000) - (asleep ? 3 : 0);
}

function updateStatus() {
  const statusEl = document.getElementById('status');
  if (!joined) {
    statusEl.textContent = "ã¾ã å‚åŠ ã—ã¦ã„ã¾ã›ã‚“";
  } else if (asleep) {
    statusEl.textContent = "å¯ãŸåˆ¤å®šï¼ã‚¿ã‚¤ãƒ ï¼š" + calculateElapsedMinutes() + "åˆ†";
  } else {
    statusEl.textContent = "å‚åŠ ä¸­ï¼ç¾åœ¨ï¼š" + calculateElapsedMinutes() + "åˆ†";
  }
}

function updateRanking() {
  const name = localStorage.getItem(STORAGE_KEY);
  if (!name) return;

  // ä»®ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
  const existing = participants.find(p => p.name === name);
  const time = calculateElapsedMinutes();

  if (joined) {
    if (existing) {
      existing.time = time;
      existing.asleep = asleep;
    } else {
      participants.push({ name, time, asleep });
    }
  }

  participants.sort((a, b) => b.time - a.time);

  const list = document.getElementById('ranking');
  list.innerHTML = "";
  participants.forEach((p, idx) => {
    const li = document.createElement('li');
    li.textContent = `${p.name}ï¼š${p.time}åˆ†`;
    if (idx === 0) li.innerHTML += ' ğŸ¥‡';
    else if (idx === 1) li.innerHTML += ' ğŸ¥ˆ';
    else if (idx === 2) li.innerHTML += ' ğŸ¥‰';
    list.appendChild(li);
  });
}

setupUI();
setInterval(() => {
  updateStatus();
  updateRanking();
}, 30000); // 30ç§’ã”ã¨ã«æ›´æ–°
