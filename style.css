const STORAGE_KEY = 'allnighter-user';
const participants = [];
let joined = false;
let asleep = false;
let joinTime = null;
let intervalId = null;
let lastConfirmTime = null;

function saveName() {
  const name = document.getElementById('username').value.trim();
  if (name) {
    localStorage.setItem(STORAGE_KEY, name);
    setupUI();
  }
}

function setupUI() {
  const name = localStorage.getItem(STORAGE_KEY);
  if (name) {
    document.getElementById('nameInput').style.display = 'none';
    document.getElementById('mainUI').style.display = 'block';
    updateStatus();
    updateRanking();
  }
}

function getNow() {
  return new Date();
}

function isWithinParticipationWindow() {
  const now = getNow();
  const h = now.getHours();
  const m = now.getMinutes();

  const totalMinutes = h * 60 + m;
  return totalMinutes >= 1320 && totalMinutes < 1440; // 22:00〜0:00
}

function isAfterStartTime() {
  const now = getNow();
  return now.getHours() >= 22 || (now.getHours() === 0 && now.getMinutes() === 0);
}

function isBeforeEndTime() {
  const now = getNow();
  const totalMinutes = now.getHours() * 60 + now.getMinutes();
  return totalMinutes < 390; // before 6:30
}

function joinChallenge() {
  if (!isAfterStartTime()) {
    alert("22:00になってから参加できます。");
    return;
  }
  if (!isWithinParticipationWindow()) {
    alert("参加受付は0:00で終了しました。");
    return;
  }
  if (joined) return;

  joinTime = new Date('1970-01-01T22:00:00'); // 開始は常に22:00からカウント
  joined = true;
  lastConfirmTime = Date.now();

  startPopupTimer();
  updateStatus();
  updateRanking();
}

function startPopupTimer() {
  intervalId = setInterval(() => {
    const now = Date.now();
    if (now - lastConfirmTime >= 10 * 60 * 1000) { // 10分
      const confirmed = confirm("起きていますか？（3分以内に押してください）");
      if (confirmed) {
        lastConfirmTime = Date.now();
      } else {
        asleep = true;
        clearInterval(intervalId);
        updateStatus();
        updateRanking();
      }
    }
  }, 60 * 1000); // 毎分チェック
}

function calculateElapsedMinutes() {
  const now = new Date();
  return Math.floor((now - joinTime) / 60000) - (asleep ? 3 : 0);
}

function updateStatus() {
  const statusEl = document.getElementById('status');
  if (!joined) {
    statusEl.textContent = "まだ参加していません";
  } else if (asleep) {
    statusEl.textContent = "寝た判定！タイム：" + calculateElapsedMinutes() + "分";
  } else {
    statusEl.textContent = "参加中！現在：" + calculateElapsedMinutes() + "分";
  }
}

function updateRanking() {
  const name = localStorage.getItem(STORAGE_KEY);
  if (!name) return;

  // 仮のランキング（ローカルのみ）
  const existing = participants.find(p => p.name === name);
  const time = calculateElapsedMinutes();

  if (joined) {
    if (existing) {
      existing.time = time;
      existing.asleep = asleep;
    } else {
      participants.push({ name, time, asleep });
    }
  }

  participants.sort((a, b) => b.time - a.time);

  const list = document.getElementById('ranking');
  list.innerHTML = "";
  participants.forEach((p, idx) => {
    const li = document.createElement('li');
    li.textContent = `${p.name}：${p.time}分`;
    if (idx === 0) li.innerHTML += ' 🥇';
    else if (idx === 1) li.innerHTML += ' 🥈';
    else if (idx === 2) li.innerHTML += ' 🥉';
    list.appendChild(li);
  });
}

setupUI();
setInterval(() => {
  updateStatus();
  updateRanking();
}, 30000); // 30秒ごとに更新
